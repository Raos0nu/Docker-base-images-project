name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  lint:
    name: Lint Dockerfiles
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: docker/base/debian-base.Dockerfile
          failure-threshold: error

      - name: Lint Node base Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: docker/base/node-base.Dockerfile
          failure-threshold: error

      - name: Lint Python base Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: docker/base/python-base.Dockerfile
          failure-threshold: error

      - name: Lint example Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: examples/node-app/Dockerfile
          failure-threshold: error

  build-base-images:
    name: Build Base Images
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        image: [debian, node, python]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate build metadata
        id: meta
        run: |
          echo "BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
          echo "VERSION=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "VCS_REF=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Build Debian base image
        if: matrix.image == 'debian'
        uses: docker/build-push-action@v5
        with:
          context: docker/
          file: docker/base/debian-base.Dockerfile
          push: false
          tags: debian-base:latest
          build-args: |
            BUILD_DATE=${{ steps.meta.outputs.BUILD_DATE }}
            VERSION=${{ steps.meta.outputs.VERSION }}
            VCS_REF=${{ steps.meta.outputs.VCS_REF }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Node base image
        if: matrix.image == 'node'
        uses: docker/build-push-action@v5
        with:
          context: docker/base/
          file: docker/base/node-base.Dockerfile
          push: false
          tags: node-base:latest
          build-args: |
            BUILD_DATE=${{ steps.meta.outputs.BUILD_DATE }}
            VERSION=${{ steps.meta.outputs.VERSION }}
            VCS_REF=${{ steps.meta.outputs.VCS_REF }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Python base image
        if: matrix.image == 'python'
        uses: docker/build-push-action@v5
        with:
          context: docker/base/
          file: docker/base/python-base.Dockerfile
          push: false
          tags: python-base:latest
          build-args: |
            BUILD_DATE=${{ steps.meta.outputs.BUILD_DATE }}
            VERSION=${{ steps.meta.outputs.VERSION }}
            VCS_REF=${{ steps.meta.outputs.VCS_REF }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-examples:
    name: Build Example Applications
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Node.js example
        uses: docker/build-push-action@v5
        with:
          context: examples/node-app/
          file: examples/node-app/Dockerfile
          push: false
          tags: demo-node:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [build-base-images, build-examples]
    strategy:
      matrix:
        image: [debian-base, node-base, python-base, demo-node]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image for scanning
        run: |
          case "${{ matrix.image }}" in
            debian-base)
              docker build -f docker/base/debian-base.Dockerfile -t ${{ matrix.image }}:latest docker/
              ;;
            node-base)
              docker build -f docker/base/node-base.Dockerfile -t ${{ matrix.image }}:latest docker/base/
              ;;
            python-base)
              docker build -f docker/base/python-base.Dockerfile -t ${{ matrix.image }}:latest docker/base/
              ;;
            demo-node)
              docker build -f examples/node-app/Dockerfile -t ${{ matrix.image }}:latest examples/node-app/
              ;;
          esac

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.image }}:latest
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build-examples
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: examples/node-app
        run: npm install

      - name: Run tests
        working-directory: examples/node-app
        run: npm test

      - name: Build and run container
        run: |
          docker build -t demo-node:test examples/node-app/
          docker run -d --name test-container -p 8080:8080 demo-node:test
          sleep 5

      - name: Test health endpoint
        run: |
          curl -f http://localhost:8080/health || exit 1
          echo "Health check passed"

      - name: Test ready endpoint
        run: |
          curl -f http://localhost:8080/ready || exit 1
          echo "Ready check passed"

      - name: Test metrics endpoint
        run: |
          curl -f http://localhost:8080/metrics || exit 1
          echo "Metrics endpoint accessible"

      - name: Test main endpoint
        run: |
          response=$(curl -s http://localhost:8080/)
          echo "Response: $response"
          if echo "$response" | grep -q "Hello from Docker base image"; then
            echo "Main endpoint test passed"
          else
            echo "Main endpoint test failed"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          docker stop test-container || true
          docker rm test-container || true

  publish:
    name: Publish Images
    runs-on: ubuntu-latest
    needs: [security-scan, test]
    if: github.event_name == 'release'
    strategy:
      matrix:
        image: [debian-base, node-base, python-base]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ secrets.DOCKER_USERNAME }}/${{ matrix.image }}
            ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.image == 'debian-base' && 'docker/' || 'docker/base/' }}
          file: docker/base/${{ matrix.image }}.Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            BUILD_DATE=${{ steps.meta.outputs.created }}
            VERSION=${{ steps.meta.outputs.version }}
            VCS_REF=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  notification:
    name: Notification
    runs-on: ubuntu-latest
    needs: [publish]
    if: always()
    steps:
      - name: Check job status
        run: |
          if [ "${{ needs.publish.result }}" == "success" ]; then
            echo "✅ Pipeline completed successfully"
          else
            echo "❌ Pipeline failed"
            exit 1
          fi

